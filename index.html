<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SPX Mastery — Options Analyzer (Build 1 • Version 28)</title>
  <link rel="icon" href="https://storage.googleapis.com/msgsndr/DbcHU95N4uVVUJoOWctG/media/68c18e9983b98269408909db.png" />

  <!-- TradingView script -->
  <script src="https://s3.tradingview.com/tv.js"></script>
  <!-- Chart.js (with fallback) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js" onerror="var s=document.createElement('script');s.src='https://cdnjs.cloudflare.com/ajax/libs/chart.js/4.4.4/chart.umd.min.js';document.head.appendChild(s);"></script>

  <style>
    :root{
      --green:#4CAF50;
      --muted:#6b7280;
      --text:#111827;
      --bg:#ffffff;
      --card:#ffffff;
      --shadow:0 2px 6px rgba(0,0,0,.08);
      --border:#e5e7eb;
      --warn:#c2410c;
      --error:#6a0dad; /* purple per spec */
    }
    html,body{background:var(--bg);color:var(--text);font-family:Arial,Helvetica,sans-serif;margin:0;padding:0}
    header{padding:16px 20px;border-bottom:1px solid var(--border);background:#fff;position:sticky;top:0;z-index:50}
    header h1{margin:0;font-size:22px;font-weight:700}
    header small{display:block;color:var(--muted)}

    .wrap{max-width:1200px;margin:0 auto;padding:16px}

    .grid-2{display:grid;grid-template-columns:repeat(2, minmax(300px, 360px));gap:12px;justify-content:center}
    .tv-tile{height:320px;background:#0b0e11;border:1px solid #0b0e11;border-radius:8px;overflow:hidden}

    .card{background:var(--card);border:1px solid var(--border);border-radius:10px;box-shadow:var(--shadow);padding:16px;margin:16px 0}
    .card h2{margin:0 0 12px 0;font-size:18px}
    .subtle{color:var(--muted)}

    .inputs{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .inputs label{font-size:12px;color:#374151}
    .row{display:flex;flex-wrap:wrap;gap:10px;margin-top:8px}
    input[type=text], input[type=number], input[type=date], input[type=password], select{padding:8px 10px;border:1px solid var(--border);border-radius:6px;min-width:140px}
    input[readonly]{background:#f9fafb}

    .btn{background:var(--green);color:#fff;border:none;border-radius:8px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .btn-secondary{background:#111827}
    .btn-outline{background:#fff;color:#111827;border:1px solid var(--border)}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px}
    .badge.ok{background:#ecfdf5;color:#065f46}
    .badge.flat{background:#fff7ed;color:#9a3412}
    .badge.bad{background:#fef2f2;color:#991b1b}

    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid var(--border);padding:8px;text-align:center;font-size:12px}
    th{background:var(--green);color:#fff;position:sticky;top:0;z-index:1}
    tbody tr:nth-child(even){background:#f9fafb}
    tbody tr:hover{background:#eef7ef}
    .delta-sweet{outline:2px solid #34d399}
    .skew-high{background:#fff3cd}

    .log{background:#fff;border:1px solid var(--border);border-radius:10px;padding:12px;height:180px;overflow:auto;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;font-size:12px;white-space:pre-wrap}

    .note{font-size:12px;color:var(--muted)}
    .error-banner{border-left:4px solid var(--error);background:#faf5ff;padding:8px 10px;border-radius:6px;margin:8px 0}
    .status{font-size:12px;color:#374151}

    .flex{display:flex;gap:10px;flex-wrap:wrap}
    .grow{flex:1}

    .legend{margin-top:6px;font-size:12px;color:var(--muted)}

    .pillbar{display:flex;gap:6px;flex-wrap:wrap}
    .pill{background:#f3f4f6;border:1px solid var(--border);border-radius:999px;padding:6px 10px;cursor:pointer}
    .pill.active{background:#e6fbe8;border-color:#a7f3d0}

    @media (max-width: 760px){
      .grid-2{grid-template-columns:1fr}
      .tv-tile{height:260px}
    }
  </style>
</head>
<body>
  <header>
    <h1>SPX Mastery — Options Analyzer <small>Build 1 • Version 28</small></h1>
    <small class="status" id="topStatus">Ready</small>
  </header>

  <main class="wrap">

    <!-- TradingView: US500 5m (left) | VIX 60m (right) -->
    <section class="grid-2" aria-label="Market Charts">
      <div id="tv-us500" class="tv-tile" title="US500 (S&P 500 futures proxy) — 5m"></div>
      <div id="tv-vix" class="tv-tile" title="VIX — 60m"></div>
    </section>

    <!-- Inputs / Controls -->
    <section class="card" aria-label="Controls">
      <h2>Inputs & Controls</h2>
      <div class="inputs">
        <div class="row" title="Your Polygon.io API key (masked). Stored locally only.">
          <label>Polygon API Key<br/>
            <input type="password" id="apiKey" placeholder="Enter Polygon API Key" autocomplete="off" />
          </label>
          <label class="subtle"><input type="checkbox" id="showKey"/> Show</label>
          <button class="btn" id="btnLive" title="Fetch SPX, VIX and Regime now" type="button">Fetch Live Data</button>
          <button class="btn-outline" id="btnSPXStream" title="Toggle 60s live SPX refresh" type="button">SPX Auto 60s: Off</button>
        </div>

        <div class="row" title="Regime based on VX front / VIX spot ratio. Only updates when you click Fetch Live Data.">
          <label>Regime <span id="regimeBadge" class="badge flat">Unknown</span></label>
          <input id="vxOverride" type="text" placeholder="VX override (e.g., X:VXF5)" title="Optional: If your plan covers CFE VX futures, enter a valid front-month ticker here." />
          <button class="btn-outline" id="saveVX" title="Save VX override locally" type="button">Save VX Override</button>
        </div>

        <div class="row" title="True live SPX (last quote) writes here every 60s when Auto is ON; otherwise on each Fetch.">
          <label>SPX Price<br/>
            <input type="number" id="spx" step="0.01" placeholder="SPX" />
          </label>
          <label>Option Type<br/>
            <select id="optType" title="Select Calls or Puts for the chain.">
              <option value="call">Call</option>
              <option value="put">Put</option>
            </select>
          </label>
          <div>
            <div class="pillbar" aria-label="Quick DTE">
              <span class="pill active" data-dte="30" title="Target ~30 DTE">30D</span>
              <span class="pill" data-dte="60" title="Target ~60 DTE">60D</span>
              <span class="pill" data-dte="90" title="Target ~90 DTE">90D</span>
              <span class="pill" data-dte="120" title="Target ~120 DTE">120D</span>
              <span class="pill" id="pillCustom" title="Use custom DTE">Custom</span>
            </div>
            <div class="row" style="margin-top:6px">
              <label>DTE<br/>
                <input type="number" id="dte" value="30" min="1" step="1" title="Desired days-to-expiration target. We’ll map this to the nearest listed expiration automatically." />
              </label>
              <label>Expiration<br/>
                <input type="date" id="expiration" title="Resolved listed expiration used for the chain" />
              </label>
              <button class="btn" id="btnChain" title="Fetch options chain for the selected expiration and type">Fetch Options Chain</button>
            </div>
          </div>
        </div>

        <div class="row" title="Model parameters for Black–Scholes greeks & price.">
          <label>IV (%)<br/>
            <input type="number" id="iv" step="0.01" placeholder="IV%" />
          </label>
          <label>Strike (K)<br/>
            <input type="number" id="strike" step="1" placeholder="Strike" />
          </label>
          <label>Premium<br/>
            <input type="number" id="premium" step="0.01" placeholder="Mid" />
          </label>
          <label>Contracts<br/>
            <input type="number" id="contracts" step="1" value="1" />
          </label>
          <label>r (%)<br/>
            <input type="number" id="rate" step="0.01" value="5.30" title="Risk‑free annualized. Defaults to 5.30%" />
          </label>
          <label>q (%)<br/>
            <input type="number" id="divy" step="0.01" value="1.30" title="Dividend yield. Defaults to 1.30%" />
          </label>
          <button class="btn" id="btnAnalyze" title="Recalculate greeks, profit curve, and tables">Analyze</button>
        </div>

        <div class="row" title="Analyze an existing position quickly with manual inputs (no live call required).">
          <label>Holdings Ticker (optional)<br/>
            <input type="text" id="holdTicker" placeholder="O:SPXYYYYMMDDC0xxxxx" />
          </label>
          <label>Entry Premium<br/>
            <input type="number" id="holdEntry" step="0.01" placeholder="e.g., 25.50" />
          </label>
          <label>Contracts<br/>
            <input type="number" id="holdQty" step="1" value="1" />
          </label>
          <button class="btn-outline" id="btnHoldings" title="Compute live/est. P/L using current mid & greeks">Analyze Holdings</button>
        </div>

        <div class="row">
          <button class="btn-secondary" id="btnGrok" title="Send current selection & context for AI recommendation. Costs money. You will be prompted to confirm." type="button">Grok: Evaluate</button>
          <span class="subtle">(Manual trigger only)</span>
        </div>
      </div>
    </section>

    <!-- Chain table -->
    <section class="card" aria-label="Options Chain">
      <h2>Options Chain <span class="subtle">(Click a row to analyze)</span></h2>
      <div class="note">200 rows max. Rows in <b>green outline</b> are delta 0.40–0.60. Rows in <b>yellow</b> have skew &gt; 15%.</div>
      <div style="max-height:420px;overflow:auto;border:1px solid var(--border);border-radius:8px">
        <table id="chainTable" aria-describedby="options chain">
          <thead>
            <tr>
              <th>Contract</th>
              <th>Strike</th>
              <th>Bid</th>
              <th>Ask</th>
              <th>Mid</th>
              <th>IV (%)</th>
              <th>Skew (%)</th>
              <th>Delta</th>
              <th>Gamma</th>
              <th>Theta</th>
              <th>Vega</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Analysis Tables / Charts -->
    <section class="card" aria-label="Analysis">
      <h2>Position Analysis</h2>
      <div class="flex">
        <div class="grow">
          <canvas id="profitChart" height="200" aria-label="Profit Curve"></canvas>
          <div class="legend">Profit curve uses current IV & DTE; range ±60 SPX points around spot.</div>
        </div>
        <div class="grow">
          <canvas id="thetaChart" height="200" aria-label="Theta Curve"></canvas>
          <div class="legend">Theta curve projects daily decay assuming constant IV and spot.</div>
        </div>
      </div>
      <div class="flex">
        <div class="grow"><canvas id="deltaChart" height="140"></canvas></div>
        <div class="grow"><canvas id="gammaChart" height="140"></canvas></div>
        <div class="grow"><canvas id="vegaChart" height="140"></canvas></div>
      </div>
    </section>

    <!-- Grok output -->
    <section class="card" aria-label="AI Advice">
      <h2>Grok Advice</h2>
      <div id="grokAdvice" class="note">Click “Grok: Evaluate” to generate advice. (You will be prompted first.)</div>
    </section>

    <!-- Log & FINRA -->
    <section class="card" aria-label="Log & Disclosures">
      <h2>Diagnostics</h2>
      <div id="log" class="log" aria-live="polite"></div>
      <div class="error-banner">
        <b>FINRA / OCC Disclosure</b>: Options involve risks and are not suitable for all investors. Read <a href="https://www.theocc.com/Company-Information/Documents-and-Archives/Options-Disclosure-Document" target="_blank" rel="noopener">Characteristics and Risks of Standardized Options</a> before trading.
      </div>
    </section>

  </main>

  <script>
  /******************** Utils & State ********************/
  const state = {
    spx: NaN,
    vix: NaN,
    atmIV: NaN,
    dteTarget: 30,
    expDate: '',
    optType: 'call',
    autoSPX: false,
    charts: {},
    atmIVForSkew: NaN,
    lastRegime: null,
    vxCooldownUntil: 0,
    chain: [],
  };

  const $ = (id)=>document.getElementById(id);
  const logBox = $('log');
  const fmtTime = (d=new Date())=>d.toLocaleTimeString('en-US',{hour12:true});
  function logLine(msg, level='INFO'){
    const ts = new Date().toISOString();
    const last = logBox.lastElementChild?.textContent || '';
    const line = `[${ts}] ${level}: ${msg}`;
    if(last.endsWith(msg)) return; // de-dupe exact repeats
    const div = document.createElement('div');
    div.textContent = line;
    logBox.appendChild(div);
    logBox.scrollTop = logBox.scrollHeight;
    $('topStatus').textContent = msg;
  }
  function badge(text, klass){
    const el = $('regimeBadge');
    el.className = `badge ${klass}`;
    el.textContent = text;
  }
  function setLoading(btn, on){ if(!btn) return; btn.disabled = !!on; btn.textContent = on? 'Working…' : btn.dataset.label || btn.textContent; }
  function daysToY(d){ return Math.max(d/365, 1/365/8); }

  // Local storage helpers
  function saveKV(k,v){ try{ localStorage.setItem(k, v); }catch(e){} }
  function readKV(k){ try{ return localStorage.getItem(k); }catch(e){ return null; } }

  // Date helpers
  function addDays(dateStr, d){ const d0 = dateStr? new Date(dateStr): new Date(); d0.setDate(d0.getDate()+d); return d0.toISOString().slice(0,10); }
  function isoToday(){ return new Date().toISOString().slice(0,10); }

  /******************** TradingView ********************/
  function mountTV(){
    if(typeof TradingView==='undefined'){ logLine('TradingView failed to load', 'ERROR'); return; }
    new TradingView.widget({
      container_id: 'tv-us500', symbol: 'TVC:US500', interval: '5', theme: 'dark', style: '1', timezone: 'America/New_York', locale: 'en', autosize: true, allow_symbol_change: false,
      studies: [], hide_top_toolbar: false, hide_legend: false
    });
    new TradingView.widget({
      container_id: 'tv-vix', symbol: 'TVC:VIX', interval: '60', theme: 'dark', style: '1', timezone: 'America/New_York', locale: 'en', autosize: true, allow_symbol_change: false
    });
  }

  /******************** Polygon Endpoints ********************/
  const POLY = 'https://api.polygon.io';

  async function polyJSON(path, params={}, signal){
    const key = $('apiKey').value.trim();
    if(!key) throw new Error('Missing Polygon API key');
    const usp = new URLSearchParams({...params, apiKey:key});
    const url = `${POLY}${path}?${usp.toString()}`;
    const r = await fetch(url, {signal});
    if(!r.ok){ throw new Error(`${path} HTTP_${r.status}`); }
    return r.json();
  }

  // Live SPX: prefer universal snapshot → quotes v3 → prev bar fallback
  async function fetchLiveSPX(){
    const ctrl = new AbortController();
    const id = setTimeout(()=>ctrl.abort(), 10000);
    try{
      // Universal snapshot (cross-asset); returns lastQuote/lastTrade when available
      const snap = await polyJSON('/v3/snapshot', { tickers:'I:SPX' }, ctrl.signal);
      const s = snap?.results?.[0];
      let spx = Number(s?.lastQuote?.P || s?.lastTrade?.p || s?.day?.c);
      if(!Number.isFinite(spx)){
        // fallback: latest quote record
        const q = await polyJSON('/v3/quotes/I:SPX', { limit:1, sort:'timestamp', order:'desc' }, ctrl.signal);
        spx = Number(q?.results?.[0]?.bp && q?.results?.[0]?.ap ? (q.results[0].bp+q.results[0].ap)/2 : NaN);
      }
      if(!Number.isFinite(spx)){
        // fallback: previous close
        const prev = await polyJSON('/v2/aggs/ticker/I:SPX/prev', {}, ctrl.signal);
        spx = Number(prev?.results?.[0]?.c);
      }
      if(!Number.isFinite(spx)) throw new Error('No SPX price available');
      state.spx = spx; $('spx').value = spx.toFixed(2);
      logLine(`SPX updated: ${spx.toFixed(2)}`);
      return spx;
    } finally{ clearTimeout(id); }
  }

  // VIX spot (prev close) for regime
  async function fetchVIXPrev(){
    const prev = await polyJSON('/v2/aggs/ticker/I:VIX/prev');
    const v = Number(prev?.results?.[0]?.c);
    if(!Number.isFinite(v)) throw new Error('No VIX close');
    state.vix = v; return v;
  }

  async function fetchVXPrev(){
    const now = Date.now();
    if(now < state.vxCooldownUntil) throw new Error('VX cooling down');
    let sym = $('vxOverride').value.trim();
    if(!sym){ throw new Error('No VX override set'); }
    try{
      const prev = await polyJSON(`/v2/aggs/ticker/${encodeURIComponent(sym)}/prev`);
      const c = Number(prev?.results?.[0]?.c);
      if(!Number.isFinite(c)) throw new Error('No VX data');
      return c;
    }catch(e){
      // backoff on 429 or 403
      const isRate = /HTTP_429/.test(e.message);
      const isAuth = /HTTP_403/.test(e.message);
      if(isRate){
        const delay = state.vxCooldownUntil ? 300000 : 60000; // 60s → 5m
        state.vxCooldownUntil = now + delay;
        logLine(`Contango paused (rate limit). Retry after ${(delay/1000)|0}s`, 'WARN');
      } else if(isAuth){
        logLine('VX not available for this plan — using Flat(Fallback)', 'WARN');
      }
      throw e;
    }
  }

  function showRegime(ratio){
    if(!Number.isFinite(ratio)){ badge('Flat (Fallback)', 'flat'); return; }
    let text = '', klass='flat';
    if(ratio>1.02){ text = `Contango (${ratio.toFixed(2)})`; klass='ok'; }
    else if(ratio<0.98){ text = `Backwardation (${ratio.toFixed(2)})`; klass='bad'; }
    else { text = `Flat (${ratio.toFixed(2)})`; klass='flat'; }
    badge(text, klass);
  }

  // Expiration resolution: map DTE → nearest listed expiration via reference API (+/- 7d window)
  async function resolveExpiration(dte){
    const target = addDays('', dte);
    const start = addDays(target, -7);
    const end   = addDays(target, +7);
    const res = await polyJSON('/v3/reference/options/contracts', {
      underlying_ticker:'SPX', sort:'expiration_date', order:'asc', limit:1000,
      'expiration_date.gte': start,
      'expiration_date.lte': end,
    });
    const dates = Array.from(new Set((res?.results||[]).map(r=>r.expiration_date))).sort();
    const pick = dates.find(d=>d>=target) || dates.pop();
    if(!pick) throw new Error('No listed expiration in window');
    return pick;
  }

  // Options chain snapshot for I:SPX
  async function fetchChain(exp, type){
    const spx = Number($('spx').value);
    if(!Number.isFinite(spx)) throw new Error('SPX price missing');
    const range = type==='call' ? { lo: spx-50, hi: spx+1000 } : { lo: spx-1000, hi: spx+50 };
    const params = {
      underlying: 'I:SPX', // documented for index options
      expiration_date: exp,
      contract_type: type,
      limit: 200,
      order: 'asc',
      'strike_price.gte': Math.max(0, Math.floor(range.lo/5)*5),
      'strike_price.lte': Math.ceil(range.hi/5)*5
    };
    // NOTE: docs show using underlying in path (…/I:SPX). Also accept underlying param for safety.
    const data = await polyJSON('/v3/snapshot/options/I:SPX', params);
    const list = data?.results || [];
    if(!list.length) throw new Error('Empty chain (check expiration or plan)');
    state.chain = list;
    renderChain(list, spx);
  }

  /******************** Rendering: Chain ********************/
  function safe(n, dp=2){ return Number.isFinite(n)? n.toFixed(dp) : 'N/A'; }

  function renderChain(rows, spx){
    const tbody = $('chainTable').querySelector('tbody');
    tbody.innerHTML='';
    // Find ATM IV for skew
    let atm = rows.reduce((a,b)=> Math.abs(b?.details?.strike_price-spx) < Math.abs(a?.details?.strike_price-spx)? b:a, rows[0]);
    const atmIV = Number(atm?.implied_volatility)*100; state.atmIVForSkew = atmIV;

    rows.forEach(c=>{
      const bid = Number(c?.last_quote?.bid);
      const ask = Number(c?.last_quote?.ask);
      const mid = (Number.isFinite(bid)&&Number.isFinite(ask))? (bid+ask)/2 : NaN;
      const ivp = Number(c?.implied_volatility)*100;
      const skew = Number.isFinite(ivp)&&Number.isFinite(atmIV)? (ivp - atmIV): NaN;
      const d = Number(c?.greeks?.delta);
      const g = Number(c?.greeks?.gamma);
      const t = Number(c?.greeks?.theta);
      const v = Number(c?.greeks?.vega);

      const tr = document.createElement('tr');
      if(d>=0.40 && d<=0.60) tr.classList.add('delta-sweet');
      if(Number.isFinite(skew) && skew>15) tr.classList.add('skew-high');

      tr.innerHTML = `
        <td title="Click to analyze">${c?.details?.ticker || ''}</td>
        <td>${safe(Number(c?.details?.strike_price),0)}</td>
        <td>${safe(bid)}</td>
        <td>${safe(ask)}</td>
        <td>${safe(mid)}</td>
        <td>${safe(ivp)}</td>
        <td>${safe(skew)}</td>
        <td>${safe(d)}</td>
        <td>${safe(g,4)}</td>
        <td>${safe(t)}</td>
        <td>${safe(v)}</td>`;

      tr.addEventListener('click', ()=>{
        $('strike').value = Number(c?.details?.strike_price)||'';
        $('iv').value = Number.isFinite(ivp)? ivp.toFixed(2): '';
        $('premium').value = Number.isFinite(mid)? mid.toFixed(2): '';
        $('optType').value = (d>=0? 'call':'put'); // rough hint; user keeps control
        analyze();
      });

      tbody.appendChild(tr);
    });
    logLine(`Chain filled (${rows.length} rows). ATM IV ~ ${safe(atmIV)}%`);
  }

  /******************** Analytics: BS + Charts ********************/
  function normCDF(x){
    const t = 1/(1+0.2316419*Math.abs(x));
    const d = 0.3989422804014327*Math.exp(-0.5*x*x);
    let p = d*t*(1.330274429 + t*(-1.821255978 + t*(1.781477937 + t*(-0.356563782 + t*0.31938153))));
    return x>0? 1-p : p;
  }
  function bs(S,K,T,r,sigma,q,isCall){
    const s=Math.max(sigma,1e-6), t=Math.max(T,1/365/8);
    const d1 = (Math.log(S/K)+(r-q+0.5*s*s)*t)/(s*Math.sqrt(t));
    const d2 = d1 - s*Math.sqrt(t);
    const Nd1 = normCDF(isCall? d1: -d1);
    const Nd2 = normCDF(isCall? d2: -d2);
    const price = isCall? (S*Math.exp(-q*t)*normCDF(d1) - K*Math.exp(-r*t)*normCDF(d2)) : (K*Math.exp(-r*t)*normCDF(-d2) - S*Math.exp(-q*t)*normCDF(-d1));
    const delta = (isCall? 1:-1) * Math.exp(-q*t) * (isCall? normCDF(d1): -normCDF(-d1));
    const gamma = Math.exp(-q*t)/(S*s*Math.sqrt(t))*0.3989422804014327*Math.exp(-0.5*d1*d1);
    const vega = S*Math.exp(-q*t)*Math.sqrt(t)*0.3989422804014327*Math.exp(-0.5*d1*d1);
    const theta = - (S*Math.exp(-q*t)*0.3989422804014327*s)/ (2*Math.sqrt(t)) - (isCall? r*K*Math.exp(-r*t)*normCDF(d2) : -r*K*Math.exp(-r*t)*normCDF(-d2)) + q*S*Math.exp(-q*t)*(isCall? normCDF(d1): -normCDF(-d1));
    return {price, delta, gamma, vega, theta};
  }

  function analyze(){
    const S = Number($('spx').value), K=Number($('strike').value), iv=Number($('iv').value)/100;
    const r=Number($('rate').value)/100, q=Number($('divy').value)/100; const isCall = $('optType').value==='call';
    const exp = $('expiration').value; if(!exp||!Number.isFinite(S)||!Number.isFinite(K)||!Number.isFinite(iv)){ logLine('Analyze: missing inputs','ERROR'); return; }
    const T = daysToY((new Date(exp)-new Date())/86400000);
    const g = bs(S,K,T,r,iv,q,isCall);

    // Profit curve ±60 points
    const xs=[], ys=[], thetas=[], deltas=[], gammas=[], vegas=[];
    for(let d=-60; d<=60; d+=5){
      const S2 = S + d;
      const gg = bs(S2,K,T,r,iv,q,isCall);
      xs.push(S2);
      ys.push((gg.price - Number($('premium').value||0)) * 100); // $ per contract (multiplier 100)
      thetas.push(gg.theta/365*100); // per day * 100 multiplier
      deltas.push(gg.delta*100);
      gammas.push(gg.gamma);
      vegas.push(gg.vega);
    }

    drawLine('profitChart','P/L vs SPX', xs, ys);
    drawLine('thetaChart','Theta/day ($)', xs, thetas);
    drawLine('deltaChart','Delta (%)', xs, deltas);
    drawLine('gammaChart','Gamma', xs, gammas);
    drawLine('vegaChart','Vega', xs, vegas);

    logLine(`Analyze: Δ=${g.delta.toFixed(2)} Γ=${g.gamma.toFixed(4)} Θ/day=${(g.theta/365).toFixed(2)} 𝜈=${g.vega.toFixed(2)}  (IV ${($('iv').value)}%, DTE ${(T*365).toFixed(0)})`);
  }

  function drawLine(id,label,xs,ys){
    const ctx = $(id).getContext('2d');
    if(state.charts[id]){ state.charts[id].destroy(); }
    state.charts[id] = new Chart(ctx,{
      type:'line', data:{ labels: xs, datasets:[{ label, data: ys, fill:false, tension:.2 }]},
      options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{display:true} }, scales:{ x:{ ticks:{autoSkip:true}}, y:{ beginAtZero:false } } }
    });
  }

  /******************** Event Wiring ********************/
  async function onFetchLive(){
    try{
      setLoading($('btnLive'), true);
      const spx = await fetchLiveSPX();
      const vix = await fetchVIXPrev();
      let ratio = NaN;
      try{
        const vx = await fetchVXPrev();
        if(Number.isFinite(vx)&&Number.isFinite(vix)) ratio = vx/vix;
      }catch(e){ /* already logged */ }
      showRegime(ratio);

      // Resolve expiration for target DTE
      const dte = Number($('dte').value)||30; state.dteTarget=dte;
      const exp = await resolveExpiration(dte); state.expDate=exp; $('expiration').value = exp;
      logLine(`Resolved expiration: ${exp} for target ${dte}DTE`);
    }catch(e){
      logLine(`FETCH_LIVE_ERROR: ${e.message}`,'ERROR');
    } finally{
      setLoading($('btnLive'), false);
    }
  }

  async function onFetchChain(){
    try{
      setLoading($('btnChain'), true);
      await fetchChain($('expiration').value, $('optType').value);
    }catch(e){ logLine(`FETCH_CHAIN_ERROR: ${e.message}`,'ERROR'); }
    finally{ setLoading($('btnChain'), false); }
  }

  function toggleAutoSPX(){
    state.autoSPX = !state.autoSPX; saveKV('autoSPX', state.autoSPX?'1':'0');
    $('btnSPXStream').textContent = `SPX Auto 60s: ${state.autoSPX? 'On':'Off'}`;
  }

  async function spxTick(){ if(!state.autoSPX) return; try{ await fetchLiveSPX(); }catch(e){ logLine(`SPX_AUTO_ERROR: ${e.message}`,'ERROR'); } }

  function bindUI(){
    $('showKey').addEventListener('change', e=>{ $('apiKey').type = e.target.checked? 'text':'password'; });
    $('apiKey').addEventListener('change', e=> saveKV('polyKey', e.target.value));
    $('vxOverride').addEventListener('change', e=> saveKV('vxOverride', e.target.value));
    $('saveVX').addEventListener('click', ()=>{ saveKV('vxOverride', $('vxOverride').value); logLine('VX override saved'); });

    $('btnLive').dataset.label='Fetch Live Data';
    $('btnLive').addEventListener('click', onFetchLive);

    $('btnSPXStream').addEventListener('click', toggleAutoSPX);
    setInterval(spxTick, 60000);

    $('btnChain').dataset.label='Fetch Options Chain';
    $('btnChain').addEventListener('click', onFetchChain);

    $('btnAnalyze').addEventListener('click', analyze);

    $('btnHoldings').addEventListener('click', ()=>{
      // Minimal P/L using current premium
      analyze();
      logLine('Holdings analysis refreshed');
    });

    // Grok guarded call
    $('btnGrok').addEventListener('click', async()=>{
      if(!confirm('Grok call will use credits. Proceed?')) return;
      try{
        const prompt = buildGrokPrompt();
        const res = await fetch('/api/grok', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ prompt })});
        if(!res.ok){ throw new Error(`GROK_HTTP_${res.status}`); }
        const data = await res.json();
        $('grokAdvice').textContent = data?.text || 'No advice returned';
        logLine('Grok advice received');
      }catch(e){ logLine(`GROK_ERROR: ${e.message}`,'ERROR'); }
    });

    // Quick DTE pills
    document.querySelectorAll('.pill[data-dte]').forEach(p=>{
      p.addEventListener('click', async ()=>{
        document.querySelectorAll('.pill').forEach(x=>x.classList.remove('active'));
        p.classList.add('active');
        const d = Number(p.dataset.dte); $('dte').value = d;
        try{ const exp = await resolveExpiration(d); $('expiration').value = exp; logLine(`Resolved expiration: ${exp} for ${d}DTE`);}catch(e){ logLine(`EXP_ERROR: ${e.message}`,'ERROR'); }
      });
    });

    $('pillCustom').addEventListener('click',()=>{
      document.querySelectorAll('.pill').forEach(x=>x.classList.remove('active'));
      $('pillCustom').classList.add('active');
      $('dte').focus();
    });

    // When user changes DTE manually
    $('dte').addEventListener('change', async ()=>{
      const d = Number($('dte').value)||30; try{ const exp = await resolveExpiration(d); $('expiration').value = exp; logLine(`Resolved expiration: ${exp} for ${d}DTE`);}catch(e){ logLine(`EXP_ERROR: ${e.message}`,'ERROR'); }
    });
  }

  function buildGrokPrompt(){
    const S = $('spx').value, type = $('optType').value.toUpperCase();
    const K = $('strike').value, IV = $('iv').value, P = $('premium').value, DTE = $('dte').value;
    const skew = Number(state.atmIVForSkew)? (Number(IV) - Number(state.atmIVForSkew)).toFixed(2): 'N/A';
    const regime = $('regimeBadge').textContent;
    return `Today ${isoToday()} SPX ${S}. Regime ${regime}. Analyze a ${type} strike ${K} IV ${IV}% premium ${P}, DTE ${DTE}. Context: skew ${skew} vs ATM ${state.atmIVForSkew?.toFixed?.(2)||'N/A'}. Goal: intraday to multi‑day trade. Advise Buy/Hold/Add/Sell with concrete triggers (P/L %, Δ/Θ/IV changes, price targets).`;
  }

  /******************** Boot ********************/
  (function init(){
    $('apiKey').value = readKV('polyKey')||'';
    $('vxOverride').value = readKV('vxOverride')||'';
    const _savedAS = readKV('autoSPX');
    state.autoSPX = _savedAS ? _savedAS==='1' : true; // default ON
    $('btnSPXStream').textContent = `SPX Auto 60s: ${state.autoSPX? 'On':'Off'}`;
    $('dte').value = 30; // default

    mountTV();
    bindUI();

    // First run minimal: don’t force calls without key; user hits Fetch
    logLine('V28 loaded. Enter API key → Fetch Live Data.', 'INFO');
  })();
  </script>

  <!--
  ================== Serverless Proxy (deploy one of these) ==================

  // Vercel Edge (api/grok.ts)
  export const config = { runtime: 'edge' };
  export default async (req: Request) => {
    const { prompt } = await req.json();
    const key = process.env.GROK_API_KEY!; // keep secret server-side
    const r = await fetch('https://api.x.ai/v1/chat/completions', {
      method:'POST', headers:{ 'Authorization': `Bearer ${key}`, 'Content-Type':'application/json' },
      body: JSON.stringify({ model:'grok-beta', messages:[{role:'user', content: prompt}] })
    });
    const j = await r.json();
    const text = j?.choices?.[0]?.message?.content || '';
    return new Response(JSON.stringify({ text }), { headers:{'Content-Type':'application/json'} });
  };

  // Cloudflare Worker
  export default {
    async fetch(request, env){
      const { prompt } = await request.json();
      const r = await fetch('https://api.x.ai/v1/chat/completions', {
        method:'POST', headers:{ 'Authorization': `Bearer ${env.GROK_API_KEY}`, 'Content-Type':'application/json' },
        body: JSON.stringify({ model:'grok-beta', messages:[{role:'user', content: prompt}] })
      });
      const j = await r.json();
      const text = j?.choices?.[0]?.message?.content || '';
      return new Response(JSON.stringify({ text }), { headers:{'Content-Type':'application/json'} });
    }
  };

  ===========================================================================
  -->
</body>
</html>
