<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>SPX Mastery Long-Term Options Analyzer — Build 1 V27</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>

  <!-- TradingView -->
  <script src="https://s3.tradingview.com/tv.js"></script>

  <style>
    /* ---- Keep original look & feel ---- */
    body { font-family: Arial, sans-serif; margin:20px; background-color:#f4f4f4; }
    h1,h2,h3 { color:#333; text-align:center; }
    .input-section { background:#fff; padding:20px; margin:20px auto; max-width:800px; box-shadow:0 2px 5px rgba(0,0,0,.1); }
    .input-group { display:flex; justify-content:space-around; margin:10px 0; flex-wrap:wrap; gap:6px; }
    input, select { padding:5px; width:140px; }
    button { padding:10px 20px; background:#4CAF50; color:#fff; border:none; cursor:pointer; margin:2px; }
    .chart-container { width:100%; max-width:800px; margin:20px auto; background:#fff; padding:20px; box-shadow:0 2px 5px rgba(0,0,0,.1); }
    table { border-collapse:collapse; width:100%; margin:20px 0; }
    th, td { border:1px solid #ddd; padding:8px; text-align:center; }
    th { background:#4CAF50; color:#fff; }
    tr:nth-child(even){ background:#f2f2f2; }
    tr:hover { background:#e8f5e8; }
    .error { color:purple; text-align:center; font-weight:bold; background:#ffebee; padding:10px; border:1px solid #ef9a9a; display:none; }
    .after-hours { color:orange; font-style:italic; text-align:center; margin:5px 0; }
    .tradingview-container { display:flex; justify-content:space-around; flex-wrap:wrap; max-width:800px; margin:20px auto; }
    .tradingview-container div { width:48%; min-width:300px; height:400px; margin:10px 0; }
    .finra-disclosure { background:#f8f9fa; padding:20px; margin:20px auto; max-width:800px; border:1px solid #ccc; font-size:12px; text-align:left; }
    #contangoStatus { text-align:center; font-weight:bold; margin:10px 0; }
    .contango { color:teal; }
    .backwardation { color:purple; }
    .flat { color:orange; }
    .skew-high { background:#ffcc00; }     /* flag high skew rows */
    .suggested-row { outline:2px solid #4CAF50; } /* delta 0.40–0.60 */
  </style>
</head>
<body>
  <h1>SPX Mastery Long-Term Options Analyzer (Build 1, Version 27)</h1>

  <!-- TradingView side-by-side (kept exactly as spec: US500 5m, VIX 60m, dark) -->
  <div class="tradingview-container">
    <div id="tvchart-us500"></div>
    <div id="tvchart-vix"></div>
  </div>

  <div class="input-section">
    <h2>Input Parameters (Click Update to Recalculate)</h2>

    <div class="input-group">
      <label>API Key:
        <input type="text" id="apiKey" placeholder="Enter Polygon API Key">
      </label>
      <label>Provider:
        <select id="apiProvider">
          <option value="polygon" selected>Polygon</option>
          <option value="alpha">Alpha Vantage</option>
          <option value="finnhub">Finnhub</option>
        </select>
      </label>
      <button id="fetchLiveBtn">Fetch Live Data</button>
      <button id="fetchChainBtn">Fetch Options Chain</button>
      <button id="testApiBtn">Test API</button>
    </div>

    <div id="contangoStatus" class="flat">Contango/Backwardation: Loading...</div>

    <div class="input-group">
      <label>SPX Price:
        <input type="number" id="spx" step="0.01" title="Current SPX price (auto-fills).">
      </label>
      <label>Strike (K):
        <input type="number" id="strike" step="1" title="Auto-fills from selected chain row.">
      </label>
      <label>Expiration:
        <input type="date" id="expiration" title="YYYY-MM-DD (filter chain)">
      </label>
      <label>IV (%):
        <input type="number" id="iv" step="0.01" title="Implied Volatility from selected contract.">
      </label>
    </div>

    <div class="input-group">
      <label>Premium:
        <input type="number" id="premium" step="0.01" title="Mid price from selected row.">
      </label>
      <label>Contracts:
        <input type="number" id="contracts" value="1" min="1" step="1" title="Contract qty.">
      </label>
      <label>Risk-Free (r %):
        <input type="number" id="riskFree" step="0.01" value="5.30" title="Default 5.30%">
      </label>
      <label>Dividend (q %):
        <input type="number" id="dividend" step="0.01" value="1.30" title="Default 1.30%">
      </label>
    </div>

    <div class="input-group">
      <label>EDR Quick:
        <button data-edr="30">30 Days</button>
        <button data-edr="60">60 Days</button>
        <button data-edr="90">90 Days</button>
      </label>
      <label>Custom EDR (%):
        <input type="number" id="customEdr" step="0.01">
      </label>
      <label>IV Source:
        <select id="ivSource"><option value="live">Live</option><option value="manual">Manual</option></select>
      </label>
      <label>Option Type:
        <select id="optionType"><option value="call">Call</option><option value="put">Put</option></select>
      </label>
      <button id="updateBtn">Update</button>
      <button id="etfProxyBtn">ETF Proxy</button>
    </div>

    <div class="input-group">
      <label>Auto-Refresh:
        <select id="refreshInterval">
          <option value="5000">5s</option>
          <option value="15000">15s</option>
          <option value="60000">1min</option>
        </select>
        <input type="checkbox" id="autoRefresh" checked>
      </label>
      <label>Mute Alerts: <input type="checkbox" id="alertMute"></label>
      <button id="snoozeAlert">Snooze Alerts (5 min)</button>
    </div>

    <!-- VX override for contango safety if month-code guess isn't on your plan -->
    <div class="input-group">
      <label>VX Override (optional):
        <input type="text" id="vxOverride" placeholder="e.g., X:VXF5 (front VIX future)">
      </label>
      <button id="saveVx">Save VX Override</button>
    </div>
  </div>

  <div id="afterHoursNote" class="after-hours"></div>
  <div id="status" class="fetch-success"></div>
  <div id="errorDisplay" class="error"></div>

  <div class="chart-container">
    <h2>DTE Forecast (Theta Burn, Vega Sensitivity)</h2>
    <table id="dteTable">
      <thead><tr><th>DTE</th><th>Theta (Proj)</th><th>Vega (Proj)</th><th>Notes</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="chart-container">
    <h2>Options Chain (Select Row for Strike/Premium/IV)</h2>
    <table id="optionsTable">
      <thead>
        <tr><th>Strike</th><th>Bid</th><th>Ask</th><th>Mid</th><th>IV (%)</th><th>Skew (%)</th><th>Delta</th><th>Gamma</th><th>Theta</th><th>Vega</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <p>Highlighted rows: delta 0.40–0.60. Skew &gt; 15% flagged in yellow.</p>
  </div>

  <div class="chart-container">
    <h2>Position Analysis</h2>
    <table id="positionTable">
      <thead><tr><th>Scenario</th><th>SPX Needed</th><th>Delta</th><th>Gamma</th><th>Theta</th><th>Vega</th><th>Price</th><th>P/L ($)</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="chart-container">
    <h3>Delta Chart</h3><canvas id="deltaChart"></canvas>
    <h3>Gamma Chart</h3><canvas id="gammaChart"></canvas>
    <h3>Theta Chart</h3><canvas id="thetaChart"></canvas>
    <h3>Vega Chart</h3><canvas id="vegaChart"></canvas>
    <div class="legend">Favorable | Caution | Risky</div>
  </div>

  <div class="chart-container">
    <h3>Profit Curve</h3>
    <canvas id="profitChart"></canvas>
  </div>

  <p id="notes"><strong>Notes:</strong> Uses Black-Scholes for greeks; select contract from chain (delta 0.4–0.6 sweet spot). EDR ~95% move estimate. Contango uses front VX future/spot. Not financial advice.</p>

  <div class="finra-disclosure" id="finra-disclosure">
    <h3>Full FINRA Options Disclosure</h3>
    <p>Options involve risks and are not suitable for all investors. Prior to buying or selling an option, a person must receive a copy of <em>Characteristics and Risks of Standardized Options</em>. See <a href="https://www.theocc.com/Company-Information/Documents-and-Archives/Options-Disclosure-Document" target="_blank" rel="noopener">www.theocc.com</a>.</p>
    <ul>
      <li><strong>Risk of Loss:</strong> You may lose your entire investment or more, particularly with uncovered strategies.</li>
      <li><strong>Complexity:</strong> Options are complex financial instruments.</li>
      <li><strong>Leverage:</strong> Leverage amplifies gains and losses.</li>
      <li><strong>Time Decay:</strong> Value may decrease rapidly as expiration approaches.</li>
      <li><strong>Market Risk:</strong> Subject to volatility, liquidity, and underlying price changes.</li>
      <li><strong>Assignment Risk:</strong> Sellers may be assigned at any time.</li>
    </ul>
    <p>Educational use only.</p>
  </div>

  <script>
    /* =========================
       Helpers / Globals
    ========================== */
    const holidays = ['2025-01-01','2025-07-04','2025-12-25'];
    const $ = (id) => document.getElementById(id);
    const safeNum = (v) => Number.isFinite(v) ? v : NaN;
    const fmt = (v, d=2) => Number.isFinite(v) ? v.toFixed(d) : 'N/A';
    let charts = {};
    let atmIVCache = null;
    let refreshTimer = null;

    function logError(msg) {
      const box = $('errorDisplay');
      box.style.display = 'block';
      const ts = new Date().toISOString();
      box.innerHTML += `<div>[${ts}] ${msg}</div>`;
      console.error(msg);
    }
    function setStatus(msg) {
      $('status').textContent = msg;
    }
    function inET() {
      const f = new Intl.DateTimeFormat('en-US',{timeZone:'America/New_York', hour:'numeric', minute:'numeric', hour12:false});
      const parts = f.formatToParts(new Date());
      return { h:+parts.find(p=>p.type==='hour').value, m:+parts.find(p=>p.type==='minute').value };
    }
    function setMarketBanner() {
      const {h,m} = inET();
      const today = new Date().toISOString().slice(0,10);
      const isHoliday = holidays.includes(today);
      const after = isHoliday || h < 9 || (h===9 && m<30) || h >= 16;
      $('afterHoursNote').style.display = after ? 'block' : 'none';
      $('afterHoursNote').textContent = after ? `After-Hours: Using previous close / last-known. [ET ${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}]` : '';
      return after;
    }
    async function wait(ms){ return new Promise(r=>setTimeout(r,ms)); }
    async function withTimeout(p, ms=10000){
      return Promise.race([p, new Promise((_,rej)=>setTimeout(()=>rej(new Error('FETCH_TIMEOUT')), ms))]);
    }

    /* =========================
       Black-Scholes (greeks only)
    ========================== */
    function nCdf(x){
      const t = 1/(1+0.2316419*Math.abs(x));
      const d = 0.3989422804014327*Math.exp(-x*x/2);
      let prob = 1 - d*(1.330274429*t**5 -1.821255978*t**4 +1.781477937*t**3 -0.356563782*t**2 +0.31938153*t);
      return x<0 ? 1-prob : prob;
    }
    function bsGreeks(S,K,T,r,sigma,q,type){
      const vs = sigma*Math.sqrt(T);
      const d1 = (Math.log(S/K)+(r-q+0.5*sigma*sigma)*T)/vs;
      const d2 = d1 - vs;
      const nd1 = Math.exp(-0.5*d1*d1)/Math.sqrt(2*Math.PI);
      const dq = Math.exp(-q*T), dr=Math.exp(-r*T);
      const delta = (type==='call' ? dq*nCdf(d1) : -dq*nCdf(-d1));
      const gamma = dq*nd1/(S*vs);
      const theta = (-(S*dq*nd1*sigma)/(2*Math.sqrt(T)) - (type==='call' ? r*K*dr*nCdf(d2) : -r*K*dr*nCdf(-d2)) + (type==='call'? q*S*dq*nCdf(d1) : -q*S*dq*nCdf(-d1)))/252;
      const vega = S*dq*nd1*Math.sqrt(T)/100;
      return {delta,gamma,theta,vega};
    }
    function yearsTo(expStr){
      if(!expStr) return 0.0001;
      const exp = new Date(expStr+'T16:00:00Z');
      const now = new Date();
      const days = Math.max((exp-now)/(1000*60*60*24), 0.001);
      return days/365;
    }

    /* =========================
       TradingView Widgets
    ========================== */
    function loadTV(){
      new TradingView.widget({
        symbol:"TVC:US500", interval:"5", timezone:"America/New_York",
        theme:"dark", style:"1", locale:"en", toolbar_bg:"#f1f3f6",
        enable_publishing:false, allow_symbol_change:true, container_id:"tvchart-us500"
      });
      new TradingView.widget({
        symbol:"TVC:VIX", interval:"60", timezone:"America/New_York",
        theme:"dark", style:"1", locale:"en", toolbar_bg:"#f1f3f6",
        enable_publishing:false, allow_symbol_change:true, container_id:"tvchart-vix"
      });
    }

    /* =========================
       Polygon Fetchers
    ========================== */
    async function fetchSPXandVIXPrev(){
      const key = $('apiKey').value.trim();
      if(!key){ logError('API_ERROR_NO_KEY: Enter valid Polygon key.'); throw new Error('NO_KEY'); }
      const spxUrl = `https://api.polygon.io/v2/aggs/ticker/I:SPX/prev?apiKey=${key}`;
      const vixUrl = `https://api.polygon.io/v2/aggs/ticker/I:VIX/prev?apiKey=${key}`;
      const [sRes,vRes] = await Promise.all([withTimeout(fetch(spxUrl)), withTimeout(fetch(vixUrl))]);
      if(!sRes.ok) throw new Error(`API_ERROR_SPX_HTTP_${sRes.status}`);
      if(!vRes.ok) throw new Error(`API_ERROR_VIX_HTTP_${vRes.status}`);
      const s = await sRes.json(), v = await vRes.json();
      const spx = s?.results?.[0]?.c, vix = v?.results?.[0]?.c;
      if(!Number.isFinite(spx)) throw new Error('API_ERROR_NO_SPX_DATA');
      if(!Number.isFinite(vix)) throw new Error('API_ERROR_NO_VIX_DATA');
      return { spx, vix };
    }

    async function fetchOptionsSnapshot({exp, type, minStrike, maxStrike}){
      const key = $('apiKey').value.trim();
      if(!key) throw new Error('NO_KEY');
      // Use Polygon V3 snapshot filters. Safer (documented) style uses dot filters: strike_price.gte / strike_price.lte
      const params = new URLSearchParams({
        limit: '200',
        order: 'asc',
        contract_type: type
      });
      if(exp) params.set('expiration_date', exp);
      if(Number.isFinite(minStrike)) params.set('strike_price.gte', String(Math.max(1, Math.floor(minStrike))));
      if(Number.isFinite(maxStrike)) params.set('strike_price.lte', String(Math.floor(maxStrike)));
      const url = `https://api.polygon.io/v3/snapshot/options/SPX?${params.toString()}&apiKey=${key}`;
      const res = await withTimeout(fetch(url));
      if(!res.ok) throw new Error(`API_ERROR_CHAIN_HTTP_${res.status}`);
      const data = await res.json();
      if(!Array.isArray(data?.results) || data.results.length===0) throw new Error('API_ERROR_NO_CHAIN_RESULTS');
      return data.results;
    }

    function computeATMIV(results, spx){
      // choose contract with strike closest to SPX, use its IV (%)
      const atm = results.reduce((best, c) => {
        const diff = Math.abs((c?.details?.strike_price ?? 0) - spx);
        const bestDiff = Math.abs((best?.details?.strike_price ?? Infinity) - spx);
        return diff < bestDiff ? c : best;
      }, results[0]);
      const ivPct = Number.isFinite(atm?.implied_volatility) ? atm.implied_volatility * 100 : NaN;
      return ivPct;
    }

    function fillChain(results, spx){
      const body = $('optionsTable').querySelector('tbody');
      body.innerHTML = '';
      const atmIV = computeATMIV(results, spx);
      atmIVCache = atmIV;

      for(const c of results){
        const strike = c?.details?.strike_price;
        const bid = safeNum(c?.last_quote?.bid);
        const ask = safeNum(c?.last_quote?.ask);
        const mid = Number.isFinite(bid)&&Number.isFinite(ask) ? (bid+ask)/2 : NaN;

        const ivPct = Number.isFinite(c?.implied_volatility) ? c.implied_volatility*100 : NaN;
        const skew = (Number.isFinite(ivPct)&&Number.isFinite(atmIV)) ? (ivPct - atmIV) : NaN;

        const d = c?.greeks?.delta, g = c?.greeks?.gamma, th = c?.greeks?.theta, v = c?.greeks?.vega;
        // Filter 0.10–0.60 delta (keep as spec)
        if(!(Number.isFinite(d) && d >= 0.10 && d <= 0.60)) continue;

        const tr = document.createElement('tr');
        if(d >= 0.40 && d <= 0.60) tr.classList.add('suggested-row');
        if(Number.isFinite(skew) && skew > 15) tr.classList.add('skew-high');

        tr.innerHTML = `
          <td>${fmt(strike,0)}</td>
          <td>${fmt(bid)}</td>
          <td>${fmt(ask)}</td>
          <td>${fmt(mid)}</td>
          <td>${fmt(ivPct,2)}</td>
          <td>${fmt(skew,2)}</td>
          <td>${fmt(d,2)}</td>
          <td>${Number.isFinite(g)? g.toFixed(4):'N/A'}</td>
          <td>${fmt(th,2)}</td>
          <td>${fmt(v,2)}</td>
        `;
        tr.addEventListener('click', ()=>{
          $('strike').value = Number.isFinite(strike)? strike : '';
          $('iv').value = Number.isFinite(ivPct)? ivPct.toFixed(2) : '';
          $('premium').value = Number.isFinite(mid)? mid.toFixed(2) : '';
          // you can call update calcs here if desired
        });
        body.appendChild(tr);
      }
    }

    async function fetchContango(vixSpot){
      const key = $('apiKey').value.trim();
      let vx = $('vxOverride').value.trim() || localStorage.getItem('vxOverride') || '';
      if(!vx){
        // month code guess (front month): F G H J K M N Q U V X Z (Jan-Dec)
        const codes = 'FGHJKMNQUVXZ'.split('');
        const m = new Date().getMonth(); // 0..11
        const y = new Date().getFullYear() % 10;
        vx = `X:VX${codes[m]}${y}`;
      }
      try{
        const url = `https://api.polygon.io/v2/aggs/ticker/${encodeURIComponent(vx)}/prev?apiKey=${key}`;
        const res = await withTimeout(fetch(url));
        if(!res.ok) throw new Error(`API_ERROR_FUT_HTTP_${res.status}`);
        const data = await res.json();
        const fut = data?.results?.[0]?.c;
        if(!Number.isFinite(fut)) throw new Error('API_ERROR_NO_FUT_DATA');
        const ratio = fut / vixSpot;
        if(ratio > 1.02) $('contangoStatus').innerHTML = `<span class="contango">Contango (${ratio.toFixed(2)}): Buy Calm Upside</span>`;
        else if(ratio < 0.98) $('contangoStatus').innerHTML = `<span class="backwardation">Backwardation (${ratio.toFixed(2)}): Avoid Longs—Short Vol</span>`;
        else $('contangoStatus').innerHTML = `<span class="flat">Flat (${ratio.toFixed(2)}): Neutral Market</span>`;
      }catch(e){
        $('contangoStatus').innerHTML = `<span class="flat">Flat (Fallback): Neutral Market</span>`;
        logError(`CONTANGO_ERROR: ${e.message}`);
      }
    }

    /* =========================
       UI Actions
    ========================== */
    async function handleFetchLive(){
      const btn = $('fetchLiveBtn'); btn.disabled = true; btn.textContent = 'Fetching...';
      try{
        const after = setMarketBanner();
        const {spx, vix} = await fetchSPXandVIXPrev();
        $('spx').value = fmt(spx);
        setStatus(`FETCH_SUCCESS: SPX/VIX Updated [${after?'Prev/Last Known':'Live/Current Session — indices are delayed ~15m'}] @ ${new Date().toLocaleTimeString()}`);
        await fetchContango(vix);
      }catch(e){
        logError(`FETCH_LIVE_ERROR: ${e.message}`);
      }finally{
        btn.disabled = false; btn.textContent = 'Fetch Live Data';
      }
    }

    async function handleFetchChain(){
      const btn = $('fetchChainBtn'); btn.disabled = true; btn.textContent = 'Fetching...';
      try{
        const spx = parseFloat($('spx').value);
        if(!Number.isFinite(spx)){ throw new Error('INPUT_ERROR: SPX is empty; fetch live first.'); }
        const exp = $('expiration').value || '';
        const type = $('optionType').value || 'call';

        // strike band per spec
        const minStrike = (type==='call') ? spx - 50 : spx - 1000;
        const maxStrike = (type==='call') ? spx + 1000 : spx + 50;

        const results = await fetchOptionsSnapshot({exp, type, minStrike, maxStrike});
        fillChain(results, spx);

        // set ATM IV for header field if empty
        const atmIV = atmIVCache;
        if(Number.isFinite(atmIV) && !$('iv').value) $('iv').value = atmIV.toFixed(2);

        setStatus(`FETCH_CHAIN_SUCCESS: Options chain updated @ ${new Date().toLocaleTimeString()}`);
      }catch(e){
        logError(`FETCH_CHAIN_ERROR: ${e.message}`);
      }finally{
        btn.disabled = false; btn.textContent = 'Fetch Options Chain';
      }
    }

    function handleETFProxy(){
      $('spx').value = '6614.00';
      $('iv').value = '12.00';
      setStatus(`PROXY_SUCCESS: Using ETF proxy values @ ${new Date().toLocaleTimeString()}`);
    }

    function handleSaveVX(){
      const v = $('vxOverride').value.trim();
      if(v){ localStorage.setItem('vxOverride', v); setStatus(`Saved VX override: ${v}`); }
    }

    function startAutoRefresh(){
      clearInterval(refreshTimer);
      if(!$('autoRefresh').checked) return;
      const iv = parseInt($('refreshInterval').value,10) || 15000;
      refreshTimer = setInterval(async ()=>{
        try{
          await handleFetchLive();
          // only refresh chain if an expiration is chosen (prevents rate bust)
          if($('expiration').value) await handleFetchChain();
        }catch(_){}
      }, iv);
    }

    function wireButtons(){
      $('fetchLiveBtn').addEventListener('click', handleFetchLive);
      $('fetchChainBtn').addEventListener('click', handleFetchChain);
      $('testApiBtn').addEventListener('click', async ()=>{
        try{
          const key = $('apiKey').value.trim();
          if(!key) throw new Error('NO_KEY');
          const url = `https://api.polygon.io/v2/aggs/ticker/I:SPX/prev?apiKey=${key}`;
          const res = await withTimeout(fetch(url));
          const txt = await res.text();
          setStatus(`TEST_API_RESPONSE: ${res.status} — see console`);
          console.log('TEST_API_RAW:', txt);
        }catch(e){ logError(`TEST_API_ERROR: ${e.message}`); }
      });
      $('etfProxyBtn').addEventListener('click', handleETFProxy);
      $('updateBtn').addEventListener('click', ()=> setStatus(`UPDATED @ ${new Date().toLocaleTimeString()}`));
      $('saveVx').addEventListener('click', handleSaveVX);
      document.querySelectorAll('button[data-edr]').forEach(b=>{
        b.addEventListener('click', ()=> setStatus(`EDR set: ${b.dataset.edr} days`));
      });
      $('refreshInterval').addEventListener('change', startAutoRefresh);
      $('autoRefresh').addEventListener('change', startAutoRefresh);
    }

    /* =========================
       Grok Evaluation (Task #5)
    ========================== */
    async function grokEvaluate(promptText){
      // IMPORTANT: x.ai tends to require server-side calls due to CORS.
      // If CORS blocks in browser, proxy this fetch through your server.
      const GROK_API_KEY = localStorage.getItem('GROK_API_KEY') || '';
      if(!GROK_API_KEY){ throw new Error('NO_GROK_KEY'); }
      const res = await withTimeout(fetch('https://api.x.ai/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${GROK_API_KEY}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          model: 'grok-beta',
          messages: [{ role:'user', content: promptText }]
        })
      }), 15000);
      if(!res.ok) throw new Error(`GROK_HTTP_${res.status}`);
      const data = await res.json();
      const msg = data?.choices?.[0]?.message?.content || 'No response';
      return msg;
    }

    /* =========================
       Boot
    ========================== */
    window.addEventListener('load', async ()=>{
      // restore persisted values
      const savedKey = localStorage.getItem('apiKey');
      if(savedKey) $('apiKey').value = savedKey;
      $('apiKey').addEventListener('change', ()=> localStorage.setItem('apiKey', $('apiKey').value.trim()));
      const savedVX = localStorage.getItem('vxOverride');
      if(savedVX) $('vxOverride').value = savedVX;

      setMarketBanner();
      loadTV();
      wireButtons();
      startAutoRefresh();

      // initial warm-up: get SPX/VIX (then user pulls chain)
      try{ await handleFetchLive(); }catch(_){}
    });
  </script>
</body>
</html>
