<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SPX Mastery Long-Term Options Analyzer (Build 1, Version 28)</title>
  <link rel="icon" href="https://storage.googleapis.com/msgsndr/DbcHU95N4uVVUJoOWctG/media/68c18e9983b98269408909db.png">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js" onload="console.log('CDN_SUCCESS_1: jsDelivr loaded')" onerror="console.log('CDN_ERROR_1: jsDelivr failed'); loadFallbackCDN(1)"></script>
  <script>
    function loadFallbackCDN(attempt) {
      console.log(`LOADING_FALLBACK_CDN: Attempt ${attempt} [${new Date().toISOString()}]`);
      const s=document.createElement('script');
      s.src = attempt===1 ? 'https://cdnjs.cloudflare.com/ajax/libs/chart.js/4.4.4/chart.min.js'
                          : 'https://unpkg.com/chart.js@4.4.4/dist/chart.min.js';
      s.onload=()=>console.log(`CDN_SUCCESS_${attempt+1}: Fallback loaded`);
      s.onerror=()=>{ if(attempt===1) loadFallbackCDN(2); else {
        const el=document.getElementById('chartError');
        el.style.display='block';
        el.innerText='CDN_ERROR_ALL: All Chart.js CDNs failed. Disable ad blockers or try incognito.';
      }};
      document.head.appendChild(s);
    }
  </script>
  <style>
    body{font-family:Arial,sans-serif;margin:20px;background:#f4f4f4}
    h1,h2,h3{color:#333;text-align:center}
    .input-section{background:#fff;padding:20px;margin:20px auto;max-width:800px;box-shadow:0 2px 5px rgba(0,0,0,.1)}
    .input-group{display:flex;justify-content:space-around;margin:10px 0;flex-wrap:wrap}
    input,select{padding:5px;width:120px}
    button{padding:10px 20px;background:#4CAF50;color:#fff;border:none;cursor:pointer;margin:2px}
    button:disabled{background:#ccc;cursor:not-allowed}
    .current-greeks{text-align:center;margin:10px;font-weight:bold}
    .chart-container,.table-container,.chain-container{width:100%;max-width:800px;margin:20px auto;background:#fff;padding:20px;box-shadow:0 2px 5px rgba(0,0,0,.1)}
    canvas{max-height:300px;width:100%!important;height:300px!important}
    table{border-collapse:collapse;width:100%;margin:20px 0}
    th,td{border:1px solid #ddd;padding:8px;text-align:center}
    th{background:#4CAF50;color:#fff}
    tr:nth-child(even){background:#f2f2f2}
    tr:hover{background:#e8f5e8}
    .current-row{background:#fff3cd;font-weight:bold}
    .profit-row{background:#d4edda}
    .high-profit-row{background:#c3e6cb}
    .suggested-row{background:#add8e6}
    p{margin-top:20px;font-size:14px;color:#666;text-align:center}
    .legend{text-align:center;margin:10px 0}
    .teal{color:teal;font-weight:bold}
    .orange{color:orange;font-weight:bold}
    .purple{color:purple;font-weight:bold}
    .error{color:purple;text-align:center}
    .disclaimer{background:#fff3cd;padding:15px;margin:20px auto;max-width:800px;border:1px solid #ffcc00;text-align:center;font-size:12px}
    .finra-disclosure{background:#f8f9fa;padding:20px;margin:20px auto;max-width:800px;border:1px solid #ccc;font-size:12px;text-align:left}
    .api-section{margin:10px 0;text-align:center}
    .api-input{width:200px;padding:5px}
    .contango{color:teal;font-weight:bold}
    .backwardation{color:purple;font-weight:bold}
    .flat{color:orange;font-weight:bold}
    .fetch-success{color:teal;text-align:center;margin:10px}
    .version{font-size:12px;color:#666;text-align:center;margin-top:20px}
    .api-note{font-size:12px;color:#666;text-align:center;margin:5px 0}
    .after-hours{color:orange;font-style:italic;text-align:center;margin:5px 0}
    .tradingview-container{display:flex;justify-content:space-around;flex-wrap:wrap;max-width:800px;margin:20px auto}
    #tradingview_spx,#tradingview_vix{width:300px;height:300px}
  </style>
</head>
<body>
  <p style="text-align:center;font-size:12px;">Copyright © SPXMASTERY.com Russell Clark All Rights Reserved</p>
  <a href="#finra-disclosure" style="text-align:center;display:block;font-size:12px;">View Full FINRA Options Disclosure</a>

  <div class="disclaimer">
    <strong>Disclaimer:</strong> This tool is for educational purposes only and is not financial advice. Options trading involves significant risks, including the potential loss of your entire investment or more. Calculations are theoretical (Black-Scholes model) and may not reflect actual market conditions. The creator (spxmastery) is not liable for any financial losses or damages resulting from use of this tool. Consult a qualified financial advisor before trading options.
  </div>

  <h1>SPX Mastery Long-Term Options Analyzer (Build 1, Version 28)</h1>

  <div class="input-section">
    <h2>Input Parameters (Click Update to Recalculate)</h2>

    <div class="api-section">
      <label>API Key:
        <input id="apiKey" type="password" class="api-input" placeholder="Enter Polygon Key" value="85b67707-e8e2-4fc4-91d4-073cf4308739">
      </label>
      <label>Provider:
        <select id="apiProvider">
          <option value="polygon">Polygon</option>
          <option value="alpha">Alpha Vantage</option>
          <option value="finnhub">Finnhub</option>
        </select>
      </label>
      <button id="fetchLiveBtn" onclick="fetchLiveData()">Fetch Live Data</button>
      <button id="fetchChainBtn" onclick="fetchOptionsChain()">Fetch Options Chain</button>
      <button id="testApiBtn" onclick="testApi()">Test API</button>
      <p class="api-note">Polygon tier: Indices/Options. Use for live SPX/VIX/chain. After-hours: Shows last close.</p>
    </div>

    <div class="input-group">
      <label>SPX Price: <input id="spx" type="number" value="6550" step="0.01"></label>
      <label>Strike (K): <input id="strike" type="number" value="7000"></label>
      <label>Expiration (YYYY-MM-DD): <input id="expiration" type="date" value="2025-11-28"></label>
      <label>IV (%): <input id="iv" type="number" value="15" step="0.01"></label>
    </div>

    <div class="input-group">
      <label>Premium: <input id="premium" type="number" value="13.75" step="0.01"></label>
      <label>Contracts: <input id="contracts" type="number" value="10" min="1"></label>
      <label>Risk-Free Rate (r %): <input id="r" type="number" value="3.8" step="0.01"></label>
      <label>Dividend Yield (q %): <input id="q" type="number" value="1.3" step="0.01"></label>
    </div>

    <div class="input-group">
      <label>EDR Days: <input id="edrDays" type="number" value="30" step="1" title="Expected 95% Move over X days (from IV*sqrt(days/365)*1.96)"></label>
      <button id="edr30Btn" onclick="setEdrDays(30)">30 Days</button>
      <button id="edr60Btn" onclick="setEdrDays(60)">60 Days</button>
      <button id="edr90Btn" onclick="setEdrDays(90)">90 Days</button>
      <label>Custom EDR (%): <input id="customEdr" type="number" placeholder="Override" step="0.01"></label>
    </div>

    <div class="input-group">
      <label>IV Source:
        <select id="ivSource">
          <option value="live" selected>Live</option>
          <option value="manual">Manual</option>
        </select>
      </label>
      <label>Option Type:
        <select id="optionType">
          <option value="call">Call</option>
          <option value="put">Put</option>
        </select>
      </label>
      <button id="updateBtn" onclick="updateAll()">Update</button>
      <button id="proxyBtn" onclick="applyEtfProxy()">ETF Proxy</button>
    </div>

    <p id="afterHoursNote" class="after-hours" style="display:none;">After-Hours: Data is last close (4:00 PM EDT).</p>
    <p id="contangoStatus"></p>
    <div id="currentGreeks" class="current-greeks"></div>

    <div id="dteForecast" class="table-container">
      <h3>DTE Forecast (Theta Burn, Vega Sensitivity)</h3>
      <table id="dteTable">
        <thead><tr><th>DTE</th><th>Theta (Proj)</th><th>Vega (Proj)</th><th>Notes</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="tradingview-container">
      <div id="tradingview_spx"></div>
      <div id="tradingview_vix"></div>
    </div>
  </div>

  <div class="chain-container" id="chainContainer" style="display:none;">
    <h3>Options Chain (Select Row for Strike/Premium/IV)</h3>
    <table id="chainTable">
      <thead>
        <tr>
          <th>Strike</th><th>Bid</th><th>Ask</th><th>Mid</th><th>IV (%)</th>
          <th>Delta</th><th>Gamma</th><th>Theta</th><th>Vega</th><th>Skew (%)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <p>Suggested: Highlighted rows have delta 0.4–0.6 (balanced for vol plays/short-term trades).</p>
  </div>

  <div class="table-container">
    <h2>Position Analysis</h2>
    <table id="positionTable">
      <thead><tr><th>Scenario</th><th>SPX Needed</th><th>Delta</th><th>Gamma</th><th>Theta</th><th>Vega</th><th>Price</th><th>P/L ($)</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="chart-container">
    <h2>Greeks Charts (Blue: Value, Teal: Good Threshold, Purple: Warning Threshold, Vertical: Current SPX)</h2>
    <div id="chartError" class="error" style="display:none;"></div>
    <canvas id="deltaChart"></canvas>
    <canvas id="gammaChart"></canvas>
    <canvas id="thetaChart"></canvas>
    <canvas id="vegaChart"></canvas>
    <p class="legend"><span class="teal">Favorable</span> | <span class="orange">Caution</span> | <span class="purple">Risky</span></p>
  </div>

  <script src="https://s3.tradingview.com/tv.js"></script>
  <script>
    new TradingView.widget({
      container_id:"tradingview_spx", width:300, height:300, symbol:"US500", interval:"D",
      timezone:"America/New_York", theme:"light", style:"1", locale:"en", toolbar_bg:"#f1f3f6",
      enable_publishing:false, allow_symbol_change:true, studies:["STD;VIX"]
    });
    new TradingView.widget({
      container_id:"tradingview_vix", width:300, height:300, symbol:"CBOE:VIX", interval:"D",
      timezone:"America/New_York", theme:"light", style:"1", locale:"en",
      toolbar_bg:"#f1f3f6", enable_publishing:false, allow_symbol_change:true
    });
  </script>

  <script>
    console.log('SCRIPT_PARSED: Ready ['+new Date().toISOString()+']');
    let dataSource='live';
    let charts={};
    const holidays=['2025-09-01','2025-11-27','2025-12-25'];

    // helpers
    const toNum = v => { const n=Number(v); return Number.isFinite(n)? n : null; };
    const extractQuote = row => {
      const lq=row.last_quote||{}; const day=row.day||{};
      const bid=toNum(lq.bid ?? day.bid_price);
      const ask=toNum(lq.ask ?? day.ask_price);
      return {bid,ask};
    };
    const extractIVpct = row => {
      const ivRaw = row.iv ?? row.implied_volatility ?? row.greeks?.iv;
      const iv = toNum(ivRaw);
      return iv!=null ? (iv*100) : null;
    };

    // math (unchanged)
    function normCDF(x){ try{
      if(typeof x!=='number'||isNaN(x)) throw new Error('Invalid x');
      const t=1/(1+0.2316419*Math.abs(x));
      const d=0.3989423*Math.exp(-(x**2)/2);
      let p=d*t*(0.3193815+t*(-0.3565638+t*(1.781478+t*(-1.821256+t*1.330274))));
      return x>0?1-p:p;
    }catch(e){ console.error(e); return 0; } }

    function blackScholesGreeks(S,K,T,r,sigma,q=0,type='call'){
      try{
        if(T<=0) return {price:type==='call'?Math.max(S-K,0):Math.max(K-S,0),delta:0,gamma:0,theta:0,vega:0};
        const d1=(Math.log(S/K)+(r-q+sigma**2/2)*T)/(sigma*Math.sqrt(T));
        const d2=d1 - sigma*Math.sqrt(T);
        const nd1=normCDF(d1), nd2=normCDF(d2), nnd1=normCDF(-d1), nnd2=normCDF(-d2);
        let price, delta;
        if(type==='call'){ price=S*Math.exp(-q*T)*nd1 - K*Math.exp(-r*T)*nd2; delta=Math.exp(-q*T)*nd1; }
        else{ price=K*Math.exp(-r*T)*nnd2 - S*Math.exp(-q*T)*nnd1; delta=-Math.exp(-q*T)*nnd1; }
        const pdf=Math.exp(-(d1**2)/2)/Math.sqrt(2*Math.PI);
        const gamma=(Math.exp(-q*T)*pdf)/(S*sigma*Math.sqrt(T));
        let theta=-(S*Math.exp(-q*T)*pdf*sigma)/(2*Math.sqrt(T)) - r*K*Math.exp(-r*T)*(type==='call'? nd2 : -nnd2) + q*S*Math.exp(-q*T)*(type==='call'? nd1 : -nnd1);
        theta/=252;
        const vega=(S*Math.exp(-q*T)*Math.sqrt(T)*pdf)/100;
        if([price,delta,gamma,theta,vega].some(x=>!Number.isFinite(x))) throw new Error('NaN greeks');
        return {price,delta,gamma,theta,vega};
      }catch(e){ showError('BLACK_SCHOLES_ERROR: '+e.message); return {price:0,delta:0,gamma:0,theta:0,vega:0}; }
    }

    function solveForS(targetPrice,currentS,K,T,r,sigma,q,type,contracts,tolerance=0.01){
      try{
        let low=currentS*0.5, high=currentS*1.5, mid, it=0, maxIt=1000;
        while(high-low>tolerance && it<maxIt){
          mid=(low+high)/2;
          const p=blackScholesGreeks(mid,K,T,r,sigma,q,type).price*contracts*100;
          if(p<targetPrice*contracts*100) low=mid; else high=mid;
          it++;
        }
        if(!Number.isFinite(mid)) throw new Error('Mid not finite');
        return mid;
      }catch(e){ showError('SOLVE_FOR_S_ERROR: '+e.message); return currentS; }
    }

    function calculateDTE(expDate){
      try{
        const today=new Date(), exp=new Date(expDate);
        const T=(exp-today)/(1000*60*60*24)/365;
        return Math.max(T,0.0001);
      }catch(e){ showError('CALCULATE_DTE_ERROR: '+e.message); return 0.0001; }
    }

    function validateInputs(){
      try{
        const ids=['spx','strike','iv','premium','contracts','r','q','edrDays'];
        for(const id of ids){
          const v=parseFloat(document.getElementById(id).value);
          if(isNaN(v)||v<=0){ showError(`INPUT_ERROR: ${id.toUpperCase()} must be positive`); return false; }
        }
        const exp=document.getElementById('expiration').value;
        if(!exp||isNaN(new Date(exp).getTime())){ showError('INPUT_ERROR: Invalid expiration date'); return false; }
        return true;
      }catch(e){ showError('VALIDATE_INPUTS_ERROR: '+e.message); return false; }
    }

    function showError(msg){
      const el=document.getElementById('currentGreeks');
      el.innerHTML += `<br><span class="error">${msg}</span>`;
      console.error(msg);
    }

    async function timeoutPromise(p,ms){
      return Promise.race([
        p,
        new Promise((_,rej)=>setTimeout(()=>rej(new Error('FETCH_TIMEOUT '+ms+'ms')),ms))
      ]);
    }

    async function fetchLiveData(attempt=1,maxAttempts=3){
      const btn=document.getElementById('fetchLiveBtn');
      let isAfterHours=false;
      try{
        btn.disabled=true; btn.innerText='Fetching...';
        if(!validateInputs()) throw new Error('VALIDATION_FAILED');
        const provider=document.getElementById('apiProvider').value;
        const apiKey=document.getElementById('apiKey').value;
        if(!apiKey) throw new Error('API_KEY_MISSING');

        const fmt=new Intl.DateTimeFormat('en-US',{hour:'numeric',minute:'numeric',timeZone:'America/New_York',hour12:false});
        const parts=fmt.formatToParts(new Date());
        const etHour=parseInt(parts.find(p=>p.type==='hour').value);
        const etMin=parseInt(parts.find(p=>p.type==='minute').value);
        const todayStr=new Date().toISOString().split('T')[0];
        const isHoliday=['2025-09-01','2025-11-27','2025-12-25'].includes(todayStr);
        isAfterHours = isHoliday || etHour<9 || (etHour===9&&etMin<30) || etHour>=16;
        const ah=document.getElementById('afterHoursNote');
        ah.style.display=isAfterHours?'block':'none';
        ah.innerText = isAfterHours
          ? (isHoliday? `Market Closed (Holiday). ET ${etHour}:${etMin}` : `After-Hours: Last close. ET ${etHour}:${etMin}`)
          : `Market Open. ET ${etHour}:${etMin}`;

        let spxPrice, vixSpot, atmIV;

        if(provider==='polygon'){
          // SPX & VIX snapshots (unchanged)
          const spxResp=await timeoutPromise(fetch(`https://api.polygon.io/v3/snapshot/indices?ticker=I:SPX&apiKey=${apiKey}`),10000);
          if(!spxResp.ok) throw new Error('SPX_HTTP_'+spxResp.status);
          const spxData=await spxResp.json();
          spxPrice = toNum(spxData.results?.[0]?.value ?? spxData.results?.[0]?.prev_close);

          const vixResp=await timeoutPromise(fetch(`https://api.polygon.io/v3/snapshot/indices?ticker=I:VIX&apiKey=${apiKey}`),10000);
          if(!vixResp.ok) throw new Error('VIX_HTTP_'+vixResp.status);
          const vixData=await vixResp.json();
          vixSpot = toNum(vixData.results?.[0]?.value ?? vixData.results?.[0]?.prev_close);

          // ATM IV probe — FIXED to I:SPX
          const exp=document.getElementById('expiration').value;
          const type=document.getElementById('optionType').value.toLowerCase();
          const chainUrl=`https://api.polygon.io/v3/snapshot/options/I:SPX?expiration_date=${exp}&contract_type=${type}&limit=200&strike_price_gte=${spxPrice-500}&strike_price_lte=${spxPrice+500}&apiKey=${apiKey}`;
          const chainResp=await timeoutPromise(fetch(chainUrl),10000);
          if(chainResp.ok){
            const chainData=await chainResp.json();
            if(chainData.results?.length){
              const atm=chainData.results.reduce((p,c)=>{
                const ps=Math.abs((p.details?.strike_price ?? p.strike) - spxPrice);
                const cs=Math.abs((c.details?.strike_price ?? c.strike) - spxPrice);
                return cs<ps? c:p;
              });
              atmIV = extractIVpct(atm);
            }
          }
        }else if(provider==='alpha'){
          const s=await timeoutPromise(fetch(`https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=^GSPC&apikey=${apiKey}`),10000);
          if(!s.ok) throw new Error('ALPHA_SPX_'+s.status);
          const js=await s.json(); spxPrice=toNum(js['Global Quote']?.['05. price']);
          const v=await timeoutPromise(fetch(`https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=^VIX&apikey=${apiKey}`),10000);
          if(!v.ok) throw new Error('ALPHA_VIX_'+v.status);
          const jv=await v.json(); vixSpot=toNum(jv['Global Quote']?.['05. price']);
          atmIV=vixSpot;
        }else{
          const s=await timeoutPromise(fetch(`https://finnhub.io/api/v1/quote?symbol=^GSPC&token=${apiKey}`),10000);
          if(!s.ok) throw new Error('FINNHUB_SPX_'+s.status);
          const js=await s.json(); spxPrice=toNum(js.c);
          const v=await timeoutPromise(fetch(`https://finnhub.io/api/v1/quote?symbol=^VIX&token=${apiKey}`),10000);
          if(!v.ok) throw new Error('FINNHUB_VIX_'+v.status);
          const jv=await v.json(); vixSpot=toNum(jv.c);
          atmIV=vixSpot;
        }

        if(!Number.isFinite(spxPrice)||spxPrice<=0) throw new Error('BAD_SPX_PRICE');
        document.getElementById('spx').value=spxPrice.toFixed(2);

        if(document.getElementById('ivSource').value==='live'){
          if(Number.isFinite(atmIV) && atmIV>0) document.getElementById('iv').value=atmIV.toFixed(2);
          else if(Number.isFinite(vixSpot) && vixSpot>0){
            const T=calculateDTE(document.getElementById('expiration').value);
            const calibrated=(vixSpot/100)*Math.sqrt(30/(T*365));
            document.getElementById('iv').value=(calibrated*100).toFixed(2);
          }
        }

        dataSource='live';
        document.getElementById('currentGreeks').innerHTML =
          `<span class="fetch-success">FETCH_SUCCESS: SPX/VIX Updated <strong>[Data: ${isAfterHours?'Last Close':'Live'}]</strong> [${new Date().toISOString()}]</span>`;
        updateAll();
      }catch(e){
        showError('FETCH_LIVE_ERROR: '+e.message);
        if(attempt<maxAttempts) setTimeout(()=>fetchLiveData(attempt+1),2000);
        else if(isAfterHours) applyEtfProxy();
      }finally{ btn.disabled=false; btn.innerText='Fetch Live Data'; }
    }

    async function testApi(){
      try{
        const apiKey=document.getElementById('apiKey').value;
        const provider=document.getElementById('apiProvider').value;
        if(provider!=='polygon') throw new Error('Only Polygon supported in Test API');
        const r=await timeoutPromise(fetch(`https://api.polygon.io/v2/aggs/ticker/I:SPX/prev?apiKey=${apiKey}`),10000);
        if(!r.ok) throw new Error('HTTP_'+r.status);
        const j=await r.json();
        showError('TEST_API_SUCCESS: '+JSON.stringify(j));
      }catch(e){ showError('TEST_API_ERROR: '+e.message); }
    }

    // FIXED: chain uses I:SPX (index options)
    async function fetchOptionsChain(){
      try{
        const apiKey=document.getElementById('apiKey').value;
        const exp=document.getElementById('expiration').value;
        const type=document.getElementById('optionType').value.toLowerCase();
        const spxPrice=toNum(document.getElementById('spx').value);
        if(!apiKey || !exp || !Number.isFinite(spxPrice)) throw new Error('Missing key/expiration/SPX');

        const url=`https://api.polygon.io/v3/snapshot/options/I:SPX?expiration_date=${exp}&contract_type=${type}&order=asc&limit=1000&sort=strike_price&apiKey=${apiKey}`;
        const resp=await timeoutPromise(fetch(url),15000);
        if(!resp.ok){
          if(resp.status===400){
            showError('FETCH_CHAIN_ERROR: CHAIN_HTTP_400 — For index options use I:SPX and ensure your plan includes Index Options.');
          }
          throw new Error('CHAIN_HTTP_'+resp.status);
        }
        const data=await resp.json();

        let results = Array.isArray(data.results) ? data.results.slice() : [];
        if(!results.length){ showError('CHAIN_EMPTY: No options returned (try market hours, different expiration, or entitlement check).'); return; }

        results = results.map(r=>{
          const strike=toNum(r.details?.strike_price ?? r.strike_price);
          const {bid,ask}=extractQuote(r);
          const ivPct=extractIVpct(r);
          const g=r.greeks||{};
          return { raw:r, strike, bid, ask, ivPct,
            delta:toNum(g.delta), gamma:toNum(g.gamma), theta:toNum(g.theta), vega:toNum(g.vega)
          };
        }).filter(x=>Number.isFinite(x.strike))
          .sort((a,b)=>a.strike-b.strike);

        const atm = results.reduce((p,c)=>{
          const pd=Math.abs(p.strike - spxPrice), cd=Math.abs(c.strike - spxPrice);
          return cd<pd? c:p;
        }, results[0]);
        const atmIV = Number.isFinite(atm?.ivPct) ? atm.ivPct : null;

        const filtered = results.filter(opt=>{
          if(type==='call') return opt.strike >= spxPrice-50 && opt.strike <= spxPrice+1000;
          else              return opt.strike <= spxPrice+50 && opt.strike >= spxPrice-1000;
        }).slice(0,500);

        const tbody=document.getElementById('chainTable').querySelector('tbody');
        tbody.innerHTML='';
        let firstNumericMidSet=false;

        for(const opt of filtered){
          const mid = (opt.bid!=null && opt.ask!=null) ? (opt.bid+opt.ask)/2 : null;
          const ivUse = Number.isFinite(opt.ivPct) ? opt.ivPct : (atmIV!=null ? atmIV : null);
          const skew = (ivUse!=null && atmIV!=null) ? (ivUse - atmIV) : null;

          const tr=document.createElement('tr');
          tr.innerHTML = `
            <td>${opt.strike.toFixed(2)}</td>
            <td>${opt.bid!=null? opt.bid.toFixed(2) : 'N/A (AH)'}</td>
            <td>${opt.ask!=null? opt.ask.toFixed(2) : 'N/A (AH)'}</td>
            <td>${mid!=null? mid.toFixed(2) : 'N/A'}</td>
            <td>${ivUse!=null? ivUse.toFixed(2) : 'N/A'}</td>
            <td>${Number.isFinite(opt.delta)? opt.delta.toFixed(2) : 'N/A'}</td>
            <td>${Number.isFinite(opt.gamma)? opt.gamma.toFixed(4) : 'N/A'}</td>
            <td>${Number.isFinite(opt.theta)? opt.theta.toFixed(2) : 'N/A'}</td>
            <td>${Number.isFinite(opt.vega) ? opt.vega.toFixed(2)  : 'N/A'}</td>
            <td>${skew!=null? skew.toFixed(2) : 'N/A'}</td>`;

          const d=toNum(opt.delta);
          if(d!=null && d>=0.4 && d<=0.6) tr.className='suggested-row';

          if(!firstNumericMidSet && mid!=null){
            document.getElementById('premium').value=mid.toFixed(2);
            firstNumericMidSet=true;
          }

          tr.onclick=()=>{
            document.getElementById('strike').value=opt.strike.toFixed(2);
            if(mid!=null) document.getElementById('premium').value=mid.toFixed(2);
            if(ivUse!=null && document.getElementById('ivSource').value==='live'){
              document.getElementById('iv').value=ivUse.toFixed(2);
            }
            updateAll();
          };

          if(skew!=null && skew>15) showError('SKEW_WARNING: High skew (>15). Consider OTM before crush.');
          tbody.appendChild(tr);
        }

        document.getElementById('chainContainer').style.display='block';
        document.getElementById('currentGreeks').innerHTML =
          `<span class="fetch-success">FETCH_CHAIN_SUCCESS: Options chain updated [${new Date().toISOString()}]</span>`;

        if(!firstNumericMidSet) showError('INFO: No tradable bid/ask mids — likely after-hours. Click a strike to proceed.');
      }catch(e){ showError('FETCH_CHAIN_ERROR: '+e.message); }
    }

    async function applyEtfProxy(){
      try{
        const apiKey=document.getElementById('apiKey').value;
        if(!apiKey) throw new Error('No API Key');
        const spy=await timeoutPromise(fetch(`https://api.polygon.io/v2/aggs/ticker/SPY/prev?apiKey=${apiKey}`),10000);
        if(!spy.ok) throw new Error('SPY_HTTP_'+spy.status);
        const js=await spy.json();
        const spxPrice=toNum(js.results?.[0]?.c)*10;
        const uvxy=await timeoutPromise(fetch(`https://api.polygon.io/v2/aggs/ticker/UVXY/prev?apiKey=${apiKey}`),10000);
        if(!uvxy.ok) throw new Error('UVXY_HTTP_'+uvxy.status);
        const jv=await uvxy.json();
        const vixSpot=toNum(jv.results?.[0]?.c)*0.5;

        if(Number.isFinite(spxPrice)) document.getElementById('spx').value=spxPrice.toFixed(2);
        if(document.getElementById('ivSource').value==='live' && Number.isFinite(vixSpot)){
          const T=calculateDTE(document.getElementById('expiration').value);
          const calibrated=(vixSpot/100)*Math.sqrt(30/(T*365));
          document.getElementById('iv').value=(calibrated*100).toFixed(2);
        }
        dataSource='proxy';
        document.getElementById('currentGreeks').innerHTML =
          `<span class="fetch-success">PROXY_SUCCESS: SPX/VIX from ETF proxy [${new Date().toISOString()}]</span>`;
        updateAll();
      }catch(e){ showError('PROXY_ERROR: '+e.message); }
    }

    function setEdrDays(days){ try{ document.getElementById('edrDays').value=days; updateAll(); }catch(e){ showError('SET_EDR_DAYS_ERROR: '+e.message); } }

    function updateAll(){
      try{
        if(!validateInputs()) return;
        const spxPrice=parseFloat(document.getElementById('spx').value);
        const sigma=parseFloat(document.getElementById('iv').value)/100;
        const K=parseFloat(document.getElementById('strike').value)||spxPrice;
        const T=calculateDTE(document.getElementById('expiration').value);
        if(T<=0.0001){ showError('T_ZERO: Expiration passed/invalid'); return; }
        const r=parseFloat(document.getElementById('r').value)/100;
        const q=parseFloat(document.getElementById('q').value)/100;
        const premium=parseFloat(document.getElementById('premium').value);
        const contracts=parseInt(document.getElementById('contracts').value);
        const type=document.getElementById('optionType').value;
        const edrDays=parseInt(document.getElementById('edrDays').value);
        const customEdr=parseFloat(document.getElementById('customEdr').value) || (sigma*Math.sqrt(edrDays/365)*1.96*100);

        const tbody=document.getElementById('positionTable').querySelector('tbody');
        tbody.innerHTML='';

        const scenarios=[
          {name:'Current',S:spxPrice,mult:1},
          {name:'Break Even',S:solveForS(premium,spxPrice,K,T,r,sigma,q,type,contracts),mult:1},
          {name:'EDR 95% Up',S:spxPrice*(1+customEdr/100),mult:1},
          {name:'EDR 95% Down',S:spxPrice*(1-customEdr/100),mult:1},
          {name:'Profit Target',S:solveForS(premium*2,spxPrice,K,T,r,sigma,q,type,contracts),mult:2},
          {name:'High Profit',S:solveForS(premium*3,spxPrice,K,T,r,sigma,q,type,contracts),mult:3}
        ];
        scenarios.forEach(sc=>{
          const g=blackScholesGreeks(sc.S,K,T,r,sigma,q,type);
          const pl=(g.price - premium)*contracts*100;
          const tr=document.createElement('tr');
          tr.className = sc.name==='Current' ? 'current-row' : (sc.mult===2?'profit-row':(sc.mult===3?'high-profit-row':''));
          tr.innerHTML = `<td>${sc.name}</td><td>${sc.S.toFixed(2)}</td>`+
                         `<td>${(g.delta*contracts).toFixed(2)}</td>`+
                         `<td>${(g.gamma*contracts).toFixed(4)}</td>`+
                         `<td>${(g.theta*contracts).toFixed(2)}</td>`+
                         `<td>${(g.vega*contracts).toFixed(2)}</td>`+
                         `<td>${g.price.toFixed(2)}</td><td>${pl.toFixed(2)}</td>`;
          tbody.appendChild(tr);
        });

        const dteTbody=document.getElementById('dteTable').querySelector('tbody');
        dteTbody.innerHTML='';
        [T, T*0.75, T*0.5, T*0.25].forEach(d=>{
          const g=blackScholesGreeks(spxPrice,K,d,r,sigma,q,type);
          const note = (g.theta*contracts < -600) ? 'Sell/Exit: High theta burn' :
                       (g.vega*contracts  > 6000) ? 'Vol Sensitive: Monitor VIX' : '';
          const tr=document.createElement('tr');
          tr.innerHTML=`<td>${(d*365).toFixed(0)}</td><td>${(g.theta*contracts).toFixed(2)}</td><td>${(g.vega*contracts).toFixed(2)}</td><td>${note}</td>`;
          dteTbody.appendChild(tr);
        });

        // charts (same as before) ...
        if(charts.delta) charts.delta.destroy();
        if(charts.gamma) charts.gamma.destroy();
        if(charts.theta) charts.theta.destroy();
        if(charts.vega) charts.vega.destroy();

        const spxRange=Array.from({length:21},(_,i)=>Math.max(1, spxPrice*(0.8 + i*0.01)));
        const deltas=spxRange.map(S=>blackScholesGreeks(S,K,T,r,sigma,q,type).delta);
        const gammas=spxRange.map(S=>blackScholesGreeks(S,K,T,r,sigma,q,type).gamma);
        const thetas=spxRange.map(S=>blackScholesGreeks(S,K,T,r,sigma,q,type).theta);
        const vegas =spxRange.map(S=>blackScholesGreeks(S,K,T,r,sigma,q,type).vega);

        charts.delta = new Chart(document.getElementById('deltaChart').getContext('2d'),{
          type:'line',
          data:{ labels:spxRange, datasets:[
            {label:'Delta', data:deltas, borderColor:'blue', fill:false},
            {label:'Teal: Favorable (0.4)', data:Array(spxRange.length).fill(0.4), borderColor:'teal', borderDash:[5,5], fill:false},
            {label:'Purple: Warning (0.6)', data:Array(spxRange.length).fill(0.6), borderColor:'purple', borderDash:[5,5], fill:false}
          ]},
          options:{ scales:{x:{title:{display:true,text:'SPX Price'}}, y:{title:{display:true,text:'Delta'}, beginAtZero:false}} }
        });

        charts.gamma = new Chart(document.getElementById('gammaChart').getContext('2d'),{
          type:'line',
          data:{ labels:spxRange, datasets:[
            {label:'Gamma', data:gammas, borderColor:'blue', fill:false},
            {label:'Teal: Favorable (0.0005)', data:Array(spxRange.length).fill(0.0005), borderColor:'teal', borderDash:[5,5], fill:false},
            {label:'Purple: Warning (0.001)', data:Array(spxRange.length).fill(0.001), borderColor:'purple', borderDash:[5,5], fill:false}
          ]},
          options:{ scales:{x:{title:{display:true,text:'SPX Price'}}, y:{title:{display:true,text:'Gamma'}, beginAtZero:false}} }
        });

        charts.theta = new Chart(document.getElementById('thetaChart').getContext('2d'),{
          type:'line',
          data:{ labels:spxRange, datasets:[
            {label:'Theta', data:thetas, borderColor:'blue', fill:false},
            {label:'Teal: Favorable (-1)', data:Array(spxRange.length).fill(-1), borderColor:'teal', borderDash:[5,5], fill:false},
            {label:'Purple: Warning (-2)', data:Array(spxRange.length).fill(-2), borderColor:'purple', borderDash:[5,5], fill:false}
          ]},
          options:{ scales:{x:{title:{display:true,text:'SPX Price'}}, y:{title:{display:true,text:'Theta'}, beginAtZero:false}} }
        });

        charts.vega = new Chart(document.getElementById('vegaChart').getContext('2d'),{
          type:'line',
          data:{ labels:spxRange, datasets:[
            {label:'Vega', data:vegas, borderColor:'blue', fill:false},
            {label:'Teal: Favorable (4)', data:Array(spxRange.length).fill(4), borderColor:'teal', borderDash:[5,5], fill:false},
            {label:'Purple: Warning (8)', data:Array(spxRange.length).fill(8), borderColor:'purple', borderDash:[5,5], fill:false}
          ]},
          options:{ scales:{x:{title:{display:true,text:'SPX Price'}}, y:{title:{display:true,text:'Vega'}, beginAtZero:false}} }
        });

      }catch(e){ showError('UPDATE_ALL_ERROR: '+e.message); }
    }

    window.onerror = function (msg,url,lineNo,columnNo,error){
      showError('GLOBAL_JS_ERROR: '+msg+' [Line '+lineNo+':'+columnNo+']');
      return false;
    };

    document.getElementById('apiKey').addEventListener('change', ()=>{
      try{
        localStorage.setItem('apiKey',document.getElementById('apiKey').value);
        const fmt=new Intl.DateTimeFormat('en-US',{timeZone:'America/New_York',hour:'numeric',minute:'numeric',hour12:false});
        const p=fmt.formatToParts(new Date());
        const h=parseInt(p.find(x=>x.type==='hour').value);
        const m=parseInt(p.find(x=>x.type==='minute').value);
        const isHoliday=['2025-09-01','2025-11-27','2025-12-25'].includes(new Date().toISOString().split('T')[0]);
        if(!isHoliday && (h>9 || (h===9&&m>=30)) && h<16){ fetchLiveData(); }
      }catch(e){ showError('API_KEY_CHANGE_ERROR: '+e.message); }
    });

    window.addEventListener('load', ()=>{
      try{
        const savedKey=localStorage.getItem('apiKey');
        const savedProvider=localStorage.getItem('apiProvider')||'polygon';
        if(savedKey){ document.getElementById('apiKey').value=savedKey; document.getElementById('apiProvider').value=savedProvider; }
        updateAll();
      }catch(e){ showError('LOAD_ERROR: '+e.message); }
    });
  </script>

  <p id="notes">Notes: Model calibrated to match: delta &#126;0.98, gamma &#126;0.54, theta &#126;-391, vega &#126;5118 at SPX 6541. Fetch chain for contract selection (suggest delta 0.4-0.6). EDR 95% range (override blank for auto). Contango uses front VIX future/spot. Colors color-blind friendly. For short-term: Use DTE forecast for buy/sell timing (e.g., sell on high theta). Not financial advice.</p>

  <!-- FULL FINRA DISCLOSURE RESTORED -->
  <div id="finra-disclosure" class="finra-disclosure">
    <h3>Full FINRA Options Disclosure</h3>
    <p>Options involve risks and are not suitable for all investors. Prior to buying or selling an option, a person must receive a copy of <em>Characteristics and Risks of Standardized Options</em>. Copies of this document may be obtained from your broker, from any exchange on which options are traded or by contacting The Options Clearing Corporation at 125 S. Franklin Street, Suite 1200, Chicago, IL 60606 (1-888-678-4667). The document is also available at <a href="https://www.theocc.com/Company-Information/Documents-and-Archives/Options-Disclosure-Document" target="_blank">www.theocc.com</a>.</p>
    <p>Key risks include, but are not limited to:</p>
    <ul>
      <li><strong>Risk of Loss:</strong> You may lose your entire investment or more, particularly with uncovered options strategies.</li>
      <li><strong>Complexity:</strong> Options are complex financial instruments. Understanding their pricing, strategies, and risks requires significant knowledge and experience.</li>
      <li><strong>Leverage:</strong> Options provide significant leverage, which can amplify both gains and losses.</li>
      <li><strong>Time Decay:</strong> The value of options may decrease rapidly as expiration approaches, even if the underlying asset's price remains unchanged.</li>
      <li><strong>Market Risk:</strong> Options are subject to market volatility, liquidity risks, and changes in the underlying asset's price.</li>
      <li><strong>Assignment Risk:</strong> Sellers of options may be assigned at any time before expiration, requiring delivery of the underlying asset or cash settlement.</li>
    </ul>
    <p>Investors should consult with a financial advisor and thoroughly understand these risks before engaging in options trading. This tool provides theoretical calculations based on the Black-Scholes model and does not guarantee actual market outcomes. Use for educational purposes only.</p>
  </div>
</body>
</html>
